apiVersion: batch/v1
kind: CronJob
metadata:
  name: paperless-backup
spec:
  schedule: "20 0 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            env:
              - name: COMPOSE_PROJECT_NAME
                value: paperless
              - name: PAPERLESS_ADMIN_MAIL
                value: michael.wittig@posteo.de
              - name: PAPERLESS_CONSUMER_RECURSIVE
                value: "1"
              - name: PAPERLESS_DBHOST
                value: paperless-ng-postgresql
              - name: PAPERLESS_ENABLE_UPDATE_CHECK
                value: "true"
              - name: PAPERLESS_OCR_LANGUAGE
                value: deu
              - name: PAPERLESS_OCR_LANGUAGES
                value: deu eng
              - name: PAPERLESS_PORT
                value: "8000"
              - name: PAPERLESS_REDIS
                value: redis://paperless-ng-redis-master:6379
              - name: PAPERLESS_TIKA_ENABLED
                value: "1"
              - name: PAPERLESS_TIKA_ENDPOINT
                value: http://paperless-ng-tika:9998
              - name: PAPERLESS_TIKA_GOTENBERG_ENDPOINT
                value: http://paperless-ng-gotenberg:3000
              - name: PAPERLESS_TIME_ZONE
                value: Europe/Berlin
              - name: PAPERLESS_URL
                value: https://paperless.ws.sh4ke.rocks
            envFrom:
              - secretRef:
                  name: paperless-ng
            image: ghcr.io/paperless-ngx/paperless-ngx:1.7.1
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - document_exporter /usr/src/paperless/data-backup
            volumeMounts:
              - mountPath: /usr/src/paperless/data-backup
                name: data-backup
              - mountPath: /usr/src/paperless/data
                name: data
              - mountPath: /usr/src/paperless/media-backup
                name: media-backup
              - mountPath: /usr/src/paperless/media
                name: media
              - mountPath: /usr/src/paperless/consume
                name: consume
              - mountPath: /usr/src/paperless/export
                name: export
              - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
                name: kube-api-access-cvgls
                readOnly: true
          volumes:
            - name: data-backup
              persistentVolumeClaim:
                claimName: paperless-ng-data-backup
            - name: data
              persistentVolumeClaim:
                claimName: paperless-ng-data
            - name: media-backup
              persistentVolumeClaim:
                claimName: paperless-ng-media-backup
            - name: media
              persistentVolumeClaim:
                claimName: paperless-ng-media
            - name: consume
              persistentVolumeClaim:
                claimName: paperless-ng-consume
            - name: export
              persistentVolumeClaim:
                claimName: paperless-ng-export
            - name: kube-api-access-cvgls
              projected:
                defaultMode: 420
                sources:
                  - serviceAccountToken:
                      expirationSeconds: 3607
                      path: token
                  - configMap:
                      items:
                        - key: ca.crt
                          path: ca.crt
                      name: kube-root-ca.crt
                  - downwardAPI:
                      items:
                        - fieldRef:
                            apiVersion: v1
                            fieldPath: metadata.namespace
                          path: namespace
          restartPolicy: OnFailure
          serviceAccount: default
          serviceAccountName: default
          nodeSelector:
            nfs-backup-enabled: "true"
